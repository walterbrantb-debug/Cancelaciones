<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel B — Curvas Vintage (pólizas)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root { --bg:#0b0c0f; --card:#141821; --muted:#94a3b8; --text:#e2e8f0; --accent:#22c55e; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--text); }
    .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 22px; margin: 0 0 14px; }
    .controls { display:flex; gap:8px; align-items:center; margin-bottom: 14px; }
    .btn { border:1px solid #2a3140; background:#1c2230; color:var(--text); padding:8px 12px; border-radius: 999px; cursor:pointer; font-weight:600; }
    .btn[aria-pressed="true"] { background: var(--accent); color:#06110a; border-color: transparent; }
    .card { background: var(--card); border: 1px solid #212838; border-radius: 14px; box-shadow: 0 1px 0 rgba(255,255,255,.04) inset; }
    .card h2 { margin: 0; font-size: 14px; color: var(--muted); font-weight:600; padding: 12px 14px; border-bottom: 1px solid #1f2533; }
    .card .content { padding: 14px; }
    .muted { color: var(--muted); font-size: 12px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; text-align: left; border-bottom: 1px solid #1f2533; }
    thead th { color: var(--muted); font-weight:600; font-size: 12px; }
    tbody td { font-size: 13px; }
    .grid { display:grid; grid-template-columns: 1fr; gap:14px; }
    @media (min-width: 900px){ .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Panel B — Curvas Vintage (pólizas)</h1>
    <div class="controls">
      <button id="btn-cancel" class="btn" aria-pressed="true">Cancelación %</button>
      <button id="btn-survive" class="btn" aria-pressed="false">Supervivencia %</button>
      <span class="muted">Corte: 31-ago-2025</span>
    </div>

    <div class="grid">
      <div class="card">
        <h2 id="chart-title">Cancelación acumulada % (pólizas)</h2>
        <div class="content">
          <canvas id="vintageChart" height="380"></canvas>
        </div>
      </div>

      <div class="card">
        <h2>Resumen rápido por camada (m0–m4)</h2>
        <div class="content">
          <div style="overflow-x:auto">
            <table>
              <thead>
                <tr>
                  <th>Cohorte</th>
                  <th>Vendidas (N)</th>
                  <th>m0</th>
                  <th>m1</th>
                  <th>m2</th>
                  <th>m3</th>
                  <th>m4</th>
                </tr>
              </thead>
              <tbody id="summary-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="muted">Notas: Cohorte = mes de emisión. Edad m = meses desde emisión hasta el fin de mes observado. Las camadas recientes no muestran edades más altas por falta de observación al 31-ago-2025.</div>
    </div>
  </div>

  <script>
    // === Datos base (cancelación acumulada % por edad) ===
    const labels = [0,1,2,3,4,5,6]; // edad en meses desde la venta
    const cohorts = [
      { label: "2025-02 (N=9)", n: 9, data: [11.11111111111111,11.11111111111111,11.11111111111111,11.11111111111111,11.11111111111111,22.22222222222222,33.33333333333333] },
      { label: "2025-03 (N=3)", n: 3, data: [0,33.33333333333333,33.33333333333333,33.33333333333333,66.66666666666666,66.66666666666666,null] },
      { label: "2025-04 (N=17)", n: 17, data: [0,11.76470588235294,23.52941176470588,23.52941176470588,23.52941176470588,null,null] },
      { label: "2025-05 (N=31)", n: 31, data: [3.225806451612903,6.451612903225806,6.451612903225806,12.903225806451612,null,null,null] },
      { label: "2025-06 (N=93)", n: 93, data: [2.150537634408602,6.451612903225806,9.67741935483871,null,null,null,null] },
      { label: "2025-07 (N=121)", n: 121, data: [3.3057851239669422,5.785123966942149,null,null,null,null,null] },
      { label: "2025-08 (N=157)", n: 157, data: [0.6369426751592357,null,null,null,null,null,null] },
    ];

    // Paleta de colores (cada camada un color distinto)
    const palette = [
      "#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd",
      "#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"
    ];

    // Construye datasets para Chart.js según la métrica
    function buildDatasets(metric) {
      return cohorts.map((c, idx) => ({
        label: c.label,
        data: c.data.map(v => v == null ? null : (metric === 'cancel' ? v : (100 - v))),
        borderColor: palette[idx % palette.length],
        backgroundColor: 'transparent',
        spanGaps: true,
        borderWidth: 2,
        pointRadius: 0,
        pointHoverRadius: 3,
        tension: 0.3,
      }));
    }

    // Tabla resumen (siempre en cancelación %)
    const summaryRows = [
      { cohorte: '2025-02', vendidas: 9,  m0:11.11, m1:11.11, m2:11.11, m3:11.11, m4:11.11 },
      { cohorte: '2025-03', vendidas: 3,  m0:0.00, m1:33.33, m2:33.33, m3:33.33, m4:66.67 },
      { cohorte: '2025-04', vendidas: 17, m0:0.00, m1:11.76, m2:23.53, m3:23.53, m4:23.53 },
      { cohorte: '2025-05', vendidas: 31, m0:3.23, m1:6.45, m2:6.45, m3:12.90, m4:null },
      { cohorte: '2025-06', vendidas: 93, m0:2.15, m1:6.45, m2:9.68, m3:null,  m4:null },
      { cohorte: '2025-07', vendidas: 121,m0:3.31, m1:5.79, m2:null,  m3:null,  m4:null },
      { cohorte: '2025-08', vendidas: 157,m0:0.64, m1:null,  m2:null,  m3:null,  m4:null },
    ];

    function pct(v){ return (v==null || Number.isNaN(v)) ? '—' : v.toFixed(1) + '%'; }

    // Render tabla
    const tbody = document.getElementById('summary-body');
    tbody.innerHTML = summaryRows.map(r => `
      <tr>
        <td><strong>${r.cohorte}</strong></td>
        <td>${r.vendidas}</td>
        <td>${pct(r.m0)}</td>
        <td>${pct(r.m1)}</td>
        <td>${pct(r.m2)}</td>
        <td>${pct(r.m3)}</td>
        <td>${pct(r.m4)}</td>
      </tr>
    `).join('');

    // Chart init
    const ctx = document.getElementById('vintageChart');
    let currentMetric = 'cancel';
    const chart = new Chart(ctx, {
      type: 'line',
      data: { labels: labels.map(m => 'm' + m), datasets: buildDatasets(currentMetric) },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'nearest', intersect: false },
        plugins: {
          legend: {
            position: 'bottom',
            labels: { color: '#cbd5e1', usePointStyle: true, pointStyle: 'line' }
          },
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y?.toFixed(2) ?? '—'}%`,
              title: items => items.length ? `Edad ${items[0].label}` : ''
            }
          }
        },
        scales: {
          x: { title: { display: true, text: 'Edad (meses desde la venta)', color: '#94a3b8' }, ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(148,163,184,.15)' } },
          y: { min: 0, max: 100, title: { display: true, text: '%', color: '#94a3b8' }, ticks: { color: '#cbd5e1', callback: v => v + '%' }, grid: { color: 'rgba(148,163,184,.15)' } }
        }
      }
    });

    // Toggle métrica
    const btnCancel = document.getElementById('btn-cancel');
    const btnSurvive = document.getElementById('btn-survive');
    const titleEl = document.getElementById('chart-title');

    function setMetric(metric){
      currentMetric = metric;
      chart.data.datasets = buildDatasets(metric);
      titleEl.textContent = metric === 'cancel' ? 'Cancelación acumulada % (pólizas)' : 'Supervivencia % (pólizas)';
      btnCancel.setAttribute('aria-pressed', metric === 'cancel');
      btnSurvive.setAttribute('aria-pressed', metric === 'survive');
      chart.update();
    }

    btnCancel.addEventListener('click', () => setMetric('cancel'));
    btnSurvive.addEventListener('click', () => setMetric('survive'));
  </script>
</body>
</html>
