<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel C — Matriz Vintage (pólizas)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0b0c0f; --card:#141821; --muted:#94a3b8; --text:#e2e8f0; --accent:#22c55e; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background: var(--bg); color: var(--text); }
    .wrap { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 22px; margin: 0 0 14px; }
    .controls { display:flex; gap:8px; align-items:center; flex-wrap: wrap; margin-bottom: 14px; }
    .btn { border:1px solid #2a3140; background:#1c2230; color:var(--text); padding:8px 12px; border-radius: 999px; cursor:pointer; font-weight:600; }
    .btn[aria-pressed="true"] { background: var(--accent); color:#06110a; border-color: transparent; }
    select { appearance:none; background:#1c2230; border:1px solid #2a3140; color:var(--text); padding:8px 12px; border-radius: 999px; font-weight:600; }
    .card { background: var(--card); border: 1px solid #212838; border-radius: 14px; box-shadow: 0 1px 0 rgba(255,255,255,.04) inset; }
    .card h2 { margin: 0; font-size: 14px; color: var(--muted); font-weight:600; padding: 12px 14px; border-bottom: 1px solid #1f2533; }
    .card .content { padding: 14px; }
    .muted { color: var(--muted); font-size: 12px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 8px 6px; text-align: left; border-bottom: 1px solid #1f2533; }
    thead th { color: var(--muted); font-weight:600; font-size: 12px; position: sticky; top: 0; background: #141821; z-index: 1; }
    tbody td { font-size: 13px; }
    .row { cursor: pointer; }
    .row:hover { background: rgba(148,163,184,.08); }
    .row.selected { outline: 2px solid #22c55e; outline-offset: 2px; }
    .cohortCell { border-left: 4px solid transparent; }
    .legend { display:flex; align-items:center; gap:6px; margin-top: 8px; }
    .swatch { height: 12px; width: 48px; border-radius: 6px; }
    .grid { display:grid; grid-template-columns: 1fr; gap:14px; }
    @media (min-width: 900px){ .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Panel C — Matriz Vintage (pólizas)</h1>
    <div class="controls">
      <button id="btn-cancel" class="btn" aria-pressed="true">Cancelación %</button>
      <button id="btn-survive" class="btn" aria-pressed="false">Supervivencia %</button>
      <label for="sort" class="muted" style="margin-left:6px">Ordenar por</label>
      <select id="sort">
        <option value="cohort">Cohorte (asc)</option>
        <option value="N">Vendidas N (desc)</option>
        <option value="final">Pérdida final % (desc)</option>
        <option value="peak13">Pico m1–m3 % (desc)</option>
      </select>
      <span class="muted" style="margin-left:auto">Corte: 31-ago-2025</span>
    </div>

    <div class="grid">
      <div class="card">
        <h2 id="matrix-title">Cancelación acumulada % por cohorte y edad</h2>
        <div class="content">
          <div style="overflow:auto; max-height: 64vh">
            <table id="matrix">
              <thead>
                <tr>
                  <th>Cohorte</th>
                  <th>N</th>
                  <th class="center">m0</th>
                  <th class="center">m1</th>
                  <th class="center">m2</th>
                  <th class="center">m3</th>
                  <th class="center">m4</th>
                  <th class="center">m5</th>
                  <th class="center">m6</th>
                  <th class="center">Final %</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
          <div class="legend muted">
            <span>Escala:</span>
            <div id="legend-swatches" style="display:flex;gap:4px"></div>
            <span id="legend-caption"></span>
          </div>
        </div>
      </div>

      <div class="muted" id="selected-note">Tip: haz clic en una fila para seleccionarla (luego podremos abrir el Panel D/E con esa cohorte).</div>
    </div>
  </div>

  <script>
    // ======= Datos base (ventas Feb–Ago 2025) =======
    const ages = [0,1,2,3,4,5,6];
    const cohorts = [
      { cohort: "2025-02", N: 9,  values: [11.1111, 11.1111, 11.1111, 11.1111, 11.1111, 22.2222, 33.3333] },
      { cohort: "2025-03", N: 3,  values: [0.0000, 33.3333, 33.3333, 33.3333, 66.6667, 66.6667, null] },
      { cohort: "2025-04", N: 17, values: [0.0000, 11.7647, 23.5294, 23.5294, 23.5294, null,   null] },
      { cohort: "2025-05", N: 31, values: [3.2258, 6.4516, 6.4516, 12.9032, null,   null,   null] },
      { cohort: "2025-06", N: 93, values: [2.1505, 6.4516, 9.6774, null,   null,   null,   null] },
      { cohort: "2025-07", N: 121,values: [3.3058, 5.7851, null,   null,   null,   null,   null] },
      { cohort: "2025-08", N: 157,values: [0.6369, null,   null,   null,   null,   null,   null] },
    ];

    // Paleta para bordes de fila
    const palette = ["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];

    // ======= Utilidades =======
    const fmtPct = (v) => (v==null || Number.isNaN(v)) ? '—' : v.toFixed(1) + '%';
    const lastDefined = (arr) => { for (let i=arr.length-1;i>=0;i--) if (arr[i]!=null) return arr[i]; return null; };
    const peakInRange = (arr, s, e) => { let mx=null; for(let i=s;i<=e && i<arr.length;i++){ const v=arr[i]; if(v!=null) mx = mx==null ? v : Math.max(mx,v);} return mx; };

    // Dominio de color (basado en cancelación acumulada)
    const observedMax = cohorts.reduce((m, r) => Math.max(m, ...r.values.map(v => v??0)), 0);
    const domainMax = Math.max(observedMax, 40); // nunca menos que 40% para contraste

    function colorFor(value, metric){
      if(value==null) return '#0b0c0f';
      const risk = metric==='cancel' ? value : (100 - value); // en supervivencia, verde alto = valor alto
      const t = Math.max(0, Math.min(1, risk / domainMax));
      const hue = 120 * (1 - t); // 120 (verde) -> 0 (rojo)
      const light = 40 + 20*(1 - t);
      return `hsl(${hue} 70% ${light}%)`;
    }

    // Estado UI
    let metric = 'cancel'; // 'cancel' | 'survive'
    let sortBy = 'cohort';
    let selectedCohort = null;

    // Elementos
    const tbody = document.getElementById('tbody');
    const titleEl = document.getElementById('matrix-title');
    const noteEl = document.getElementById('selected-note');
    const btnCancel = document.getElementById('btn-cancel');
    const btnSurvive = document.getElementById('btn-survive');
    const selectSort = document.getElementById('sort');

    function renderLegend(){
      const holder = document.getElementById('legend-swatches');
      holder.innerHTML = '';
      const steps = [0,0.25,0.5,0.75,1];
      steps.forEach(t => {
        const val = t * domainMax;
        const hue = 120*(1 - t);
        const bg = `hsl(${hue} 70% ${40 + 20*(1 - t)}%)`;
        const div = document.createElement('div');
        div.className = 'swatch';
        div.style.background = bg;
        div.title = val.toFixed(0) + '%';
        holder.appendChild(div);
      });
      const caption = document.getElementById('legend-caption');
      caption.textContent = `0% → ${domainMax.toFixed(0)}% (y más)`;
    }

    function sortedRows(){
      const rows = cohorts.map((r, idx) => ({...r, _color: palette[idx % palette.length]}));
      if (sortBy==='N') return rows.sort((a,b)=> b.N - a.N);
      if (sortBy==='final') return rows.sort((a,b)=> (lastDefined(b.values) ?? -1) - (lastDefined(a.values) ?? -1));
      if (sortBy==='peak13') return rows.sort((a,b)=> (peakInRange(b.values,1,3) ?? -1) - (peakInRange(a.values,1,3) ?? -1));
      return rows; // cohort asc (ya vienen ordenadas)
    }

    function renderTable(){
      titleEl.textContent = metric==='cancel' ? 'Cancelación acumulada % por cohorte y edad' : 'Supervivencia % por cohorte y edad';
      tbody.innerHTML = '';
      const rows = sortedRows();
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.className = 'row' + (selectedCohort===r.cohort ? ' selected' : '');
        tr.addEventListener('click', ()=> { selectedCohort = r.cohort; renderTable(); updateSelectedNote(); });

        const tdCoh = document.createElement('td');
        tdCoh.className = 'cohortCell';
        tdCoh.style.borderLeftColor = r._color;
        tdCoh.innerHTML = `<strong>${r.cohort}</strong>`;
        tr.appendChild(tdCoh);

        const tdN = document.createElement('td');
        tdN.textContent = r.N;
        tr.appendChild(tdN);

        ages.forEach(a => {
          const raw = r.values[a];
          const shown = raw==null ? null : (metric==='cancel' ? raw : (100-raw));
          const bg = colorFor(raw, metric);
          const td = document.createElement('td');
          td.style.background = bg;
          td.style.textAlign = 'center';
          td.title = `m${a}: ${fmtPct(shown)}`;
          td.innerHTML = `<span style="display:inline-block;padding:2px 4px">${fmtPct(shown)}</span>`;
          tr.appendChild(td);
        });

        const finRaw = lastDefined(r.values);
        const finShown = finRaw==null? null : (metric==='cancel' ? finRaw : (100-finRaw));
        const tdFin = document.createElement('td');
        tdFin.style.textAlign = 'center';
        tdFin.style.fontWeight = 600;
        tdFin.textContent = fmtPct(finShown);
        tr.appendChild(tdFin);

        tbody.appendChild(tr);
      });
    }

    function updateSelectedNote(){
      if(!selectedCohort){
        noteEl.textContent = 'Tip: haz clic en una fila para seleccionarla (luego podremos abrir el Panel D/E con esa cohorte).';
      } else {
        noteEl.textContent = 'Cohorte seleccionada: ' + selectedCohort + ' — usaremos esta selección para abrir el Panel D/E.';
      }
    }

    function setMetric(next){
      metric = next;
      btnCancel.setAttribute('aria-pressed', next==='cancel');
      btnSurvive.setAttribute('aria-pressed', next==='survive');
      renderTable();
    }

    // Eventos
    btnCancel.addEventListener('click', ()=> setMetric('cancel'));
    btnSurvive.addEventListener('click', ()=> setMetric('survive'));
    selectSort.addEventListener('change', (e)=> { sortBy = e.target.value; renderTable(); });

    // Init
    renderLegend();
    renderTable();
    updateSelectedNote();
  </script>
</body>
</html>
